# Dockerfile pour Claude Flow Sécurisé
FROM node:20-alpine

# Métadonnées
LABEL maintainer="Claude Flow Security Setup"
LABEL description="Container sécurisé pour Claude Flow"
LABEL version="1.1"

# Installation des dépendances système minimales
RUN apk add --no-cache \
    git \
    bash \
    curl \
    jq \
    sudo \
    && rm -rf /var/cache/apk/*

# Mettre à jour npm vers la dernière version
RUN npm install -g npm@latest

# Installation de Claude Flow en tant que root (avant de changer d'utilisateur)
RUN npm install -g claude-flow@latest && \
    npm cache clean --force

# Création d'un utilisateur non-privilégié
RUN addgroup -g 1001 -S claude && \
    adduser -S claude -u 1001 -G claude -s /bin/bash

# Répertoires de travail
RUN mkdir -p /workspace /logs /var/run/claude && \
    chown -R claude:claude /workspace /logs /var/run/claude

# Configuration des permissions de sécurité
RUN mkdir -p /home/claude/.npm && \
    chown -R claude:claude /home/claude

# Donner accès à claude-flow à l'utilisateur non-privilégié
RUN chown -R claude:claude /usr/local/lib/node_modules/claude-flow 2>/dev/null || true && \
    chown claude:claude /usr/local/bin/claude-flow 2>/dev/null || true

# Basculer vers l'utilisateur non-privilégié
USER claude

# Répertoire de travail
WORKDIR /workspace

# Configuration des ports
EXPOSE 3000 8080

# Variables d'environnement sécurisées
ENV NODE_ENV=production
ENV NPM_CONFIG_UPDATE_NOTIFIER=false
ENV NPM_CONFIG_FUND=false
ENV CLAUDE_FLOW_CONTAINER=true
ENV CLAUDE_FLOW_BIND_HOST=0.0.0.0

# Volumes pour persistance sécurisée
VOLUME ["/workspace", "/logs", "/var/run/claude"]

# Script de santé pour monitoring
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

# Point d'entrée par défaut
CMD ["claude-flow", "start", "--ui", "--port", "3000"]