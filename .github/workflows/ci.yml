name: ğŸ§ª CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Test quotidien Ã  2h du matin UTC
    - cron: '0 2 * * *'

jobs:
  # Test de construction Docker
  docker-build:
    runs-on: ubuntu-latest
    name: ğŸ³ Docker Build Test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      run: |
        docker build -t claude-flow-secure-test .
    
    - name: Test Docker image basic functionality
      run: |
        # DÃ©marrer le container en mode test
        docker run -d --name test-container \
          -p 3000:3000 -p 8080:8080 \
          claude-flow-secure-test
        
        # Attendre le dÃ©marrage
        sleep 30
        
        # VÃ©rifier que le container fonctionne
        docker ps | grep test-container
        
        # Cleanup
        docker stop test-container
        docker rm test-container

  # Tests de sÃ©curitÃ©
  security-tests:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Tests
    needs: docker-build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run security scan on Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        config: .hadolint.yaml
    
    - name: Test container security
      run: |
        # Construire l'image
        docker build -t claude-flow-security-test .
        
        # Tests de sÃ©curitÃ© de base
        echo "ğŸ” Test utilisateur non-root..."
        CONTAINER_USER=$(docker run --rm claude-flow-security-test whoami)
        if [ "$CONTAINER_USER" = "claude" ]; then
          echo "âœ… Container utilise un utilisateur non-root"
        else
          echo "âŒ Container utilise root - FAILED"
          exit 1
        fi
        
        # Test des capabilities
        echo "ğŸ” Test des capabilities..."
        docker run --rm claude-flow-security-test sh -c "
          CAPS=\$(capsh --print | grep 'Current:' | cut -d: -f2 | xargs)
          if [ -z \"\$CAPS\" ] || [ \"\$CAPS\" = \"=\" ]; then
            echo 'âœ… Pas de capabilities privilÃ©giÃ©es'
          else
            echo 'âŒ Capabilities privilÃ©giÃ©es dÃ©tectÃ©es: \$CAPS - FAILED'
            exit 1
          fi
        "

  # Tests fonctionnels
  functional-tests:
    runs-on: ubuntu-latest
    name: âš™ï¸ Functional Tests
    needs: docker-build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Make scripts executable and create workspace
      run: |
        chmod +x scripts/*.sh
        chmod +x tests/*.sh || true
        mkdir -p workspace
        echo "Test workspace created for CI/CD" > workspace/README.md
    
    - name: Test setup script
      run: |
        # Test du script d'installation (mode dry-run)
        echo "Testing setup script..."
        # ./scripts/setup.sh --dry-run  # Si implÃ©mentÃ©
    
    - name: Test Docker Compose
      run: |
        # Test de la configuration Docker Compose
        docker-compose config
        
        # Test de dÃ©marrage/arrÃªt rapide
        export UID=$(id -u)
        export GID=$(id -g)
        
        echo "ğŸš€ DÃ©marrage Docker Compose..."
        docker-compose up -d
        
        echo "â³ Attente du dÃ©marrage..."
        sleep 90
        
        echo "ğŸ§ª Tests de connectivitÃ©..."
        # Test santÃ© basique
        if curl -f http://127.0.0.1:3000/health --max-time 30; then
          echo "âœ… Service accessible"
        else
          echo "âŒ Service inaccessible"
          docker-compose logs
          exit 1
        fi
        
        echo "ğŸ›‘ ArrÃªt des services..."
        docker-compose down

  # Tests de connectivitÃ©
  connectivity-tests:
    runs-on: ubuntu-latest
    name: ğŸŒ Connectivity Tests
    needs: docker-build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Make scripts executable and create workspace
      run: |
        chmod +x scripts/*.sh
        mkdir -p workspace
        echo "Test workspace for connectivity tests" > workspace/README.md
    
    - name: Install wscat for WebSocket testing
      run: npm install -g wscat
    
    - name: Launch Claude Flow
      run: |
        # DÃ©marrage avec le script de lancement
        export UID=$(id -u)
        export GID=$(id -g)
        timeout 300 ./scripts/launch.sh &
        
        # Attendre le dÃ©marrage
        echo "Attente du dÃ©marrage des services..."
        for i in {1..120}; do
          if curl -s http://127.0.0.1:3000/health > /dev/null; then
            echo "âœ… Services dÃ©marrÃ©s aprÃ¨s ${i}0 secondes"
            break
          fi
          sleep 10
        done
    
    - name: Run connectivity tests
      run: |
        # ExÃ©cuter les tests de connectivitÃ©
        ./scripts/test-connectivity.sh --detailed
    
    - name: Cleanup
      if: always()
      run: |
        ./scripts/stop.sh --full-cleanup || true
        docker system prune -f || true

  # Tests multi-plateforme
  multi-platform:
    runs-on: ${{ matrix.os }}
    name: ğŸ–¥ï¸ Multi-Platform Tests
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-20.04]
        # Note: macOS et Windows nÃ©cessitent Docker Desktop
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Test Docker build on ${{ matrix.os }}
      run: |
        docker build -t claude-flow-test-${{ matrix.os }} .
        docker run --rm claude-flow-test-${{ matrix.os }} echo "Build successful on ${{ matrix.os }}"

  # Publication des artefacts
  publish-artifacts:
    runs-on: ubuntu-latest
    name: ğŸ“¦ Publish Artifacts
    needs: [docker-build, security-tests, functional-tests, connectivity-tests]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build final image
      run: |
        docker build -t claude-flow-secure:latest .
        docker save claude-flow-secure:latest | gzip > claude-flow-secure-image.tar.gz
    
    - name: Upload Docker image as artifact
      uses: actions/upload-artifact@v4
      with:
        name: claude-flow-secure-image
        path: claude-flow-secure-image.tar.gz
        retention-days: 30

  # Tests de performance
  performance-tests:
    runs-on: ubuntu-latest
    name: ğŸ“Š Performance Tests
    needs: docker-build
    if: github.event_name == 'schedule' || contains(github.event.pull_request.labels.*.name, 'performance')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install performance testing tools
      run: |
        sudo apt-get update
        sudo apt-get install -y apache2-utils htop
    
    - name: Launch Claude Flow for performance testing
      run: |
        chmod +x scripts/*.sh
        ./scripts/launch.sh &
        
        # Attendre le dÃ©marrage
        sleep 60
    
    - name: Run performance tests
      run: |
        echo "ğŸš€ Tests de charge basiques..."
        
        # Test de charge HTTP
        ab -n 100 -c 10 http://127.0.0.1:3000/health
        
        # MÃ©triques du container
        docker stats --no-stream claude-flow-* || true
    
    - name: Cleanup performance test
      if: always()
      run: |
        ./scripts/stop.sh --full-cleanup || true

  # Notification des rÃ©sultats
  notify:
    runs-on: ubuntu-latest
    name: ğŸ“¢ Notify Results
    needs: [docker-build, security-tests, functional-tests, connectivity-tests]
    if: always()
    
    steps:
    - name: Notification Success
      if: ${{ needs.docker-build.result == 'success' && needs.security-tests.result == 'success' && needs.functional-tests.result == 'success' && needs.connectivity-tests.result == 'success' }}
      run: |
        echo "ğŸ‰ Tous les tests sont passÃ©s avec succÃ¨s!"
        echo "âœ… Build Docker: OK"
        echo "âœ… Tests sÃ©curitÃ©: OK" 
        echo "âœ… Tests fonctionnels: OK"
        echo "âœ… Tests connectivitÃ©: OK"
    
    - name: Notification Failure
      if: ${{ needs.docker-build.result == 'failure' || needs.security-tests.result == 'failure' || needs.functional-tests.result == 'failure' || needs.connectivity-tests.result == 'failure' }}
      run: |
        echo "âŒ Some tests have failed!"
        echo "ğŸ³ Build Docker: ${{ needs.docker-build.result }}"
        echo "ğŸ”’ Tests sÃ©curitÃ©: ${{ needs.security-tests.result }}"
        echo "âš™ï¸ Tests fonctionnels: ${{ needs.functional-tests.result }}"
        echo "ğŸŒ Tests connectivitÃ©: ${{ needs.connectivity-tests.result }}"
        exit 1